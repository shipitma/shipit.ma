"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1058],{1056:(e,t,n)=>{n.d(t,{Hm:()=>T}),n(3699),n(8777);var r=n(9509),a=n(4134).Buffer;function o(){let e=_tagged_template_literal(["\n    INSERT INTO sessions (\n      id, user_id, phone_number, session_type, expires_at, \n      user_agent, ip_address, access_token, refresh_token\n    )\n    VALUES (\n      ",", ",", ",", ",", \n      ",", ",", ",",\n      ",", ","\n    )\n  "]);return o=function(){return e},e}function s(){let e=_tagged_template_literal(["\n    SELECT * FROM sessions \n    WHERE id = "," \n    AND expires_at > NOW()\n  "]);return s=function(){return e},e}function i(){let e=_tagged_template_literal(["\n    UPDATE sessions \n    SET last_accessed = NOW() \n    WHERE id = ","\n  "]);return i=function(){return e},e}function l(){let e=_tagged_template_literal(["\n    DELETE FROM sessions WHERE id = ","\n  "]);return l=function(){return e},e}function u(){let e=_tagged_template_literal(["\n    DELETE FROM sessions WHERE user_id = ","\n  "]);return u=function(){return e},e}function c(){let e=_tagged_template_literal(["\n    INSERT INTO users (\n      id, phone_number, first_name, last_name, email, \n      address_line, city, state, zip, country, phone_verified\n    )\n    VALUES (\n      ",", ",", ",", ",", \n      ",", ",", ",", \n      ",", ",", ",", true\n    )\n  "]);return c=function(){return e},e}function f(){let e=_tagged_template_literal(["\n    SELECT * FROM users WHERE phone_number = ","\n  "]);return f=function(){return e},e}function h(){let e=_tagged_template_literal(["\n    SELECT * FROM users WHERE id = ","\n  "]);return h=function(){return e},e}function d(){let e=r.env.DATABASE_URL||r.env.POSTGRES_URL;if(!e)throw Error("No database URL found. Please set DATABASE_URL or POSTGRES_URL environment variable");return neon(e)}async function T(e){if(!e.startsWith("neon_"))return!0;try{let t=JSON.parse(a.from(e.substring(5),"base64").toString()),n=Math.floor(Date.now()/1e3);return t.exp-n<=300}catch(e){return!0}}},3999:(e,t,n)=>{n.d(t,{cn:()=>o});var r=n(2596),a=n(9688);function o(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return(0,a.QP)((0,r.$)(t))}},6052:(e,t,n)=>{n.d(t,{A:()=>f,AuthProvider:()=>c});var r=n(5155),a=n(2115),o=n(1056);let s=(e,t)=>{localStorage.setItem(e,t),document.cookie="".concat(e,"=").concat(t,"; path=/; max-age=").concat(2592e3,"; SameSite=Lax")},i=e=>localStorage.getItem(e),l=e=>{localStorage.removeItem(e),document.cookie="".concat(e,"=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT")},u=(0,a.createContext)(void 0);function c(e){let{children:t}=e,[n,c]=(0,a.useState)(null),[f,h]=(0,a.useState)(null),[d,T]=(0,a.useState)(null),[_,g]=(0,a.useState)(null),[k,E]=(0,a.useState)(!0),p=async e=>{try{let t=await fetch("/api/session",{headers:{Authorization:"Bearer ".concat(e)}});if(t.ok){let e=await t.json();return c(e),!0}if(401===t.status){console.log("Session expired, attempting token refresh...");let e=i("refreshToken");if(e){let t=await m(e);if(t)return console.log("Token refreshed successfully, retrying user fetch..."),await p(t.accessToken)}console.log("Token refresh failed, clearing authentication..."),l("authToken"),l("accessToken"),l("refreshToken"),c(null),h(null),T(null)}}catch(e){console.error("Error fetching user:",e),l("authToken"),l("accessToken"),l("refreshToken"),c(null),h(null),T(null)}return!1},m=async e=>{try{console.log("Attempting to refresh access token...");let t=await fetch("/api/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e})});if(t.ok){let e=await t.json();return console.log("Token refresh successful"),s("accessToken",e.accessToken),s("authToken",e.sessionId),T(e.accessToken),h(e.sessionId),e}{console.error("Token refresh failed with status:",t.status);let e=await t.json().catch(()=>({}));console.error("Token refresh error details:",e)}}catch(e){console.error("Error refreshing token:",e)}return null},w=async()=>{try{let e=d||f;if(!e)return;if(d&&await (0,o.Hm)(d)){console.log("Token is about to expire, refreshing...");let e=i("refreshToken");if(e){let t=await m(e);if(t){let e=await fetch("/api/dashboard/stats",{headers:{Authorization:"Bearer ".concat(t.accessToken)}});if(e.ok){let t=await e.json();g(t)}return}}}let t=await fetch("/api/dashboard/stats",{headers:{Authorization:"Bearer ".concat(e)}});if(t.ok){let e=await t.json();g(e)}}catch(e){console.error("Error prefetching dashboard data:",e)}};(0,a.useEffect)(()=>{(async()=>{E(!0);let e=i("accessToken");if(e&&await p(e)){T(e),h(i("authToken")),await w(),E(!1);return}let t=i("authToken");t&&await p(t)&&(h(t),await w()),E(!1)})()},[]);let S=async(e,t,n)=>{E(!0),s("authToken",e),h(e),t?(s("accessToken",t),T(t),await p(t)):await p(e),n&&s("refreshToken",n),await w(),E(!1)},y=async()=>{try{f&&await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:f})})}catch(e){console.error("Error during logout:",e)}finally{l("authToken"),l("accessToken"),l("refreshToken"),c(null),h(null),T(null),g(null),window.location.href="/login"}},R=async()=>{let e=d||f;e&&await p(e)};return(0,r.jsx)(u.Provider,{value:{user:n,sessionId:f,accessToken:d,dashboardStats:_,loading:k,login:S,logout:y,refreshUser:R,prefetchDashboardData:w},children:t})}function f(){let e=(0,a.useContext)(u);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}}}]);